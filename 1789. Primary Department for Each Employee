WITH EmpPrimeDepTable AS
(
    SELECT
        employee_id
        ,COUNT(*) AS DepTotal
        ,MAX(primary_flag) AS Flag
    FROM Employee
    GROUP BY employee_id
    HAVING (COUNT(*) > 1 AND MAX(primary_flag) = 'Y') OR (COUNT(*) = 1 AND MAX(primary_flag) IN ('N', 'Y'))
)
SELECT
    EDT.employee_id
    ,E.department_id
FROM EmpPrimeDepTable EDT
    INNER JOIN Employee E
        ON E.employee_id = EDT.employee_id
           AND E.primary_flag = EDT.Flag
ORDER BY EDT.employee_id
